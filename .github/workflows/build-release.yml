name: Build & Release Desktop App

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Install shared-types dependencies
        run: cd packages/shared-types && npm ci

      - name: Build shared-types
        run: cd packages/shared-types && npm run build
        continue-on-error: true

      - name: Install web dependencies
        run: cd apps/web && npm ci

      - name: Build web (Next.js export)
        run: cd apps/web && npm run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:4000

      - name: Prepare exported web for Electron
        run: |
          cd apps/web
          Remove-Item ../desktop/renderer -Recurse -Force -ErrorAction SilentlyContinue
          New-Item -ItemType Directory ../desktop/renderer -Force | Out-Null
          Copy-Item out\* ../desktop/renderer -Recurse -Force

      - name: Install desktop dependencies
        run: cd apps/desktop && npm ci

      - name: Build desktop main process
        run: cd apps/desktop && npm run build:main

      - name: Validate code signing configuration
        shell: pwsh
        env:
          WIN_CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
          WIN_CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}
        run: |
          $link = $env:WIN_CSC_LINK
          $pass = $env:WIN_CSC_KEY_PASSWORD

          if ([string]::IsNullOrWhiteSpace($link) -or [string]::IsNullOrWhiteSpace($pass)) {
            Write-Error "Windows code signing secrets are required for release builds. Set WIN_CSC_LINK + WIN_CSC_KEY_PASSWORD in GitHub Secrets."
            exit 1
          }

          if ($link -match '^https?://') {
            Write-Output "WIN_CSC_LINK is URL-based; skipping local PFX validation step."
            exit 0
          }

          $normalized = ($link -replace '\s', '')
          try {
            $bytes = [Convert]::FromBase64String($normalized)
          } catch {
            Write-Error "WIN_CSC_LINK is not valid Base64 (or contains extra characters). Re-copy the full .pfx.b64 content."
            exit 1
          }

          $tmpPfx = Join-Path $env:RUNNER_TEMP 'codesign-cert.pfx'
          [IO.File]::WriteAllBytes($tmpPfx, $bytes)

          try {
            $secure = ConvertTo-SecureString -String $pass -AsPlainText -Force
            Get-PfxData -FilePath $tmpPfx -Password $secure | Out-Null
            Write-Output "PFX/password pair validated successfully."
          } catch {
            Write-Error "WIN_CSC_KEY_PASSWORD does not match WIN_CSC_LINK certificate. Update both secrets from the same generated PFX."
            exit 1
          }

      - name: Package Windows .exe
        run: cd apps/desktop && npx electron-builder --win --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WIN_CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
          WIN_CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}
          CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}

      - name: Normalize artifact names
        shell: pwsh
        run: |
          $releaseDir = "apps/desktop/release"

          $setup = Get-ChildItem "$releaseDir/NodeWeaver Setup *.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($setup) {
            Copy-Item $setup.FullName "$releaseDir/NodeWeaver-Setup.exe" -Force
          }

          $setupBlockmap = Get-ChildItem "$releaseDir/NodeWeaver Setup *.exe.blockmap" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($setupBlockmap) {
            Copy-Item $setupBlockmap.FullName "$releaseDir/NodeWeaver-Setup.exe.blockmap" -Force
          }

          $portable = Get-ChildItem "$releaseDir/NodeWeaver *.exe" -ErrorAction SilentlyContinue |
            Where-Object { $_.Name -notlike "*Setup*" -and $_.Name -ne "NodeWeaver-Setup.exe" } |
            Select-Object -First 1
          if ($portable) {
            Copy-Item $portable.FullName "$releaseDir/NodeWeaver-Portable.exe" -Force
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            apps/desktop/release/NodeWeaver-Setup.exe
            apps/desktop/release/NodeWeaver-Portable.exe
            apps/desktop/release/NodeWeaver-Setup.exe.blockmap
            apps/desktop/release/*.exe
            apps/desktop/release/*.exe.blockmap

  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Install shared-types dependencies
        run: cd packages/shared-types && npm ci

      - name: Build shared-types
        run: cd packages/shared-types && npm run build
        continue-on-error: true

      - name: Install web dependencies
        run: cd apps/web && npm ci

      - name: Build web (Next.js export)
        run: cd apps/web && npm run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:4000

      - name: Prepare exported web for Electron
        run: |
          cd apps/web
          rm -rf ../desktop/renderer
          mkdir -p ../desktop/renderer
          cp -R out/. ../desktop/renderer/

      - name: Install desktop dependencies
        run: cd apps/desktop && npm ci

      - name: Build desktop main process
        run: cd apps/desktop && npm run build:main

      - name: Package macOS app
        run: cd apps/desktop && npx electron-builder --mac --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: "false"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            apps/desktop/release/*.dmg
            apps/desktop/release/*.zip
            apps/desktop/release/latest-mac.yml

  build-linux:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Install shared-types dependencies
        run: cd packages/shared-types && npm ci

      - name: Build shared-types
        run: cd packages/shared-types && npm run build
        continue-on-error: true

      - name: Install web dependencies
        run: cd apps/web && npm ci

      - name: Build web (Next.js export)
        run: cd apps/web && npm run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:4000

      - name: Prepare exported web for Electron
        run: |
          cd apps/web
          rm -rf ../desktop/renderer
          mkdir -p ../desktop/renderer
          cp -R out/. ../desktop/renderer/

      - name: Install desktop dependencies
        run: cd apps/desktop && npm ci

      - name: Build desktop main process
        run: cd apps/desktop && npm run build:main

      - name: Package Linux app
        run: cd apps/desktop && npx electron-builder --linux --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            apps/desktop/release/*.AppImage
            apps/desktop/release/latest-linux.yml

  create-release:
    needs:
      - build-windows
      - build-macos
      - build-linux
    runs-on: ubuntu-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: release-files/windows

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-build
          path: release-files/macos

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: release-files/linux

      - name: List release files
        run: find release-files -type f

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: NodeWeaver ${{ github.ref_name }}
          body: |
            ## NodeWeaver ${{ github.ref_name }}
            
            ### üì• –°–∫–∞—á–∞—Ç—å
            - Windows: `NodeWeaver-Setup.exe` / `NodeWeaver-Portable.exe`
            - macOS: `.dmg` / `.zip`
            - Linux: `.AppImage` / `.deb`
            
            ### üìã –ò–∑–º–µ–Ω–µ–Ω–∏—è
            –°–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–º–º–∏—Ç—ã –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.
          draft: false
          prerelease: false
          files: |
            release-files/**/*.exe
            release-files/**/*.exe.blockmap
            release-files/**/*.dmg
            release-files/**/*.zip
            release-files/**/*.AppImage
            release-files/**/*.deb
            release-files/**/latest*.yml
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
